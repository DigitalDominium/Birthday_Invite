<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>üéÇ Unlock the Cake ‚Äî Blow Out the Candles</title>
  <style>
    :root{
      --bg1:#1a1b2e; --bg2:#2a2b45; --accent:#ff8fb1; --cake:#ffdac7; --cake2:#ffc7a8; --icing:#fff3fb; --shadow:rgba(0,0,0,.25);
      --candle:#66ccff; --wick:#2b2b2b; --flame1:#ffec85; --flame2:#ff9f1a; --smoke:#bfc7d6;
    }
    html, body { height:100%; }
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 50% -200px, #4650a0 0%, var(--bg1) 45%, var(--bg2) 100%);
      color:#f6f7ff; display:flex; align-items:center; justify-content:center; overflow-x:hidden;
    }
    .scene{ width:min(1000px, 96vw); padding:24px; }

    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
    .title{ font-size:clamp(22px, 4vw, 36px); font-weight:800; letter-spacing:0.3px; }
    .hint{ opacity:.8; font-size:clamp(12px, 2.4vw, 14px); }

    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:10px 0 18px; }
    button{
      background: linear-gradient(180deg, #ffffff 0%, #f3f6ff 100%);
      color:#1b1b1b; border:1px solid #d5daf2; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 18px var(--shadow); transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow:0 10px 22px var(--shadow); }
    button:active{ transform: translateY(0); }
    .badge{ padding:8px 12px; border-radius:999px; font-size:13px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); }

    .meter{ position:relative; width:180px; height:10px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden; }
    .meter > i{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, #9ad1ff, #ffcc66); }
    .meter-label{ font-size:12px; opacity:.7; margin-left:6px; }

    /* STAGE / CAKE */
    .stage{ position:relative; height:min(520px, 78vh); display:grid; place-items:end center; }
    .table{ position:absolute; left:0; right:0; bottom:0; height:26%; background: radial-gradient(800px 200px at 50% -40px, #2f2e4a 0, #211f37 60%);
            box-shadow: inset 0 25px 30px rgba(255,255,255,.05); }

    .cake-wrap{ position:relative; width:min(780px, 92vw); height:min(380px, 58vh); display:grid; place-items:center; }
    .cake{ position:relative; width:94%; max-width:720px; height:60%; min-height:220px; transition: transform .9s cubic-bezier(.2,.8,.2,1); }
    .cake.open{ transform: translateY(12px); }

    /* cake halves */
    .half{ position:absolute; bottom:0; width:50%; height:100%; border-radius:22px; overflow:visible; transform-origin:bottom center; transition: transform 1.1s cubic-bezier(.2,.8,.2,1); }
    .half:before{ content:""; position:absolute; inset:0; border-radius:22px; background: linear-gradient(180deg, var(--cake) 0%, var(--cake2) 70%);
                  box-shadow: 0 24px 40px rgba(0,0,0,.35), inset 0 -10px 0 0 rgba(0,0,0,.08); }
    .half:after{ content:""; position:absolute; left:0; right:0; top:-34px; height:48px; border-radius:999px; background: radial-gradient(200px 50px at 50% 60%, #fff 0%, var(--icing) 70%);
                 box-shadow: inset 0 -6px 0 rgba(0,0,0,.06); }
    .left{ left:0; }
    .right{ right:0; }

    .cake.open .left{ transform: translateX(-54%) rotate(-2deg); }
    .cake.open .right{ transform: translateX(54%) rotate(2deg); }

    /* candle row area (on top of cake) */
    .candles{ position:absolute; left:2%; right:2%; top:-10px; height:90px; pointer-events:none; }
    .candle{ position:absolute; bottom:14px; width:12px; height:44px; display:flex; align-items:flex-end; justify-content:center; pointer-events:auto; }
    .wax{ width:100%; height:34px; background: linear-gradient(180deg, var(--candle), #5fb8ec); border-radius:4px; box-shadow: inset 0 -5px 0 rgba(0,0,0,.08); }
    .wick{ position:absolute; top:-4px; width:2px; height:10px; background: var(--wick); border-radius:1px; }

    .flame{ position:absolute; top:-26px; width:16px; height:24px; border-radius:50% 50% 50% 50%/60% 60% 40% 40%; transform-origin:50% 90%;
            background: radial-gradient(circle at 50% 35%, #fff 0%, var(--flame1) 35%, var(--flame2) 70%, rgba(255,159,26,0) 72%);
            filter: drop-shadow(0 0 6px rgba(255,180,40,.8)); animation: flicker .12s infinite alternate; }
    .flame:after{ content:""; position:absolute; inset:0; border-radius:inherit; background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.85) 0, rgba(255,255,255,.2) 42%, rgba(255,255,255,0) 60%); mix-blend-mode:screen; }

    @keyframes flicker { from{ transform: translateX(-1px) rotate(-2deg) scale(0.96); } to{ transform: translateX(1px) rotate(2deg) scale(1.04); } }

    .candle.out .flame{ display:none; }
    .candle.out .wick{ background:#555; }

    /* smoke puffs after blow */
    .smoke{ position:absolute; top:-16px; width:6px; height:6px; pointer-events:none; }
    .puff{ position:absolute; left:0; top:0; width:6px; height:6px; border-radius:50%; background:radial-gradient(circle, rgba(255,255,255,.8), var(--smoke)); opacity:.9;
           animation: rise 1.2s ease-out forwards; filter: blur(0.4px); }
    @keyframes rise { 0%{ transform: translate(0,0) scale(1); opacity:.9; } 70%{ opacity:.5; } 100%{ transform: translate(var(--dx, 0px), -60px) scale(1.8); opacity:0; } }

    /* invite card ‚Äî solid background */
    .invite{ position:absolute; inset:auto 0 10%; margin:auto; width:min(680px, 92%); background:#ffffff; color:#1a1b2e;
             border-radius:18px; padding:22px 22px 18px; transform: translateY(35px) scale(.98); opacity:0; pointer-events:none;
             transition: all .9s cubic-bezier(.2,.8,.2,1); box-shadow: 0 20px 40px rgba(0,0,0,.35); }
    .invite.show{ transform: translateY(0) scale(1); opacity:1; pointer-events:auto; }
    .invite h2{ margin:0 0 6px; font-size:clamp(22px, 4.2vw, 32px); }
    .invite .grid{ display:grid; grid-template-columns: 1fr; gap:8px; margin-top:10px; }
    .invite .row{ display:flex; gap:10px; align-items:flex-start; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.15); font-size:13px; }
    .footer{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .rsvp{ text-decoration:none; display:inline-block; padding:10px 14px; border-radius:12px; background:linear-gradient(180deg,#ffed84,#ffc86b); color:#1a1b2e; font-weight:900; }

    /* confetti overlay */
    .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:999; }
    .confetti-piece{ position:absolute; width:10px; height:14px; opacity:.9; will-change:transform;
                     animation: fall linear forwards; border-radius:2px; }
    @keyframes fall{ to{ transform:translateY(100vh) rotate(540deg); opacity:0; } }

    .toast{ position:fixed; left:50%; top:12px; transform:translateX(-50%); background:rgba(0,0,0,.55); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; display:none; }
    .toast.show{ display:block; animation: fade 2.2s ease 0s 1 both; }
    @keyframes fade{ 0%{ opacity:0; transform: translate(-50%, -6px); } 15%{ opacity:1; transform: translate(-50%, 0); } 85%{ opacity:1; } 100%{ opacity:0; transform: translate(-50%, -6px); } }

    @media (max-width:520px){
      .candles{ top:-6px; height:76px; }
      .candle{ width:10px; height:40px; }
      .flame{ width:14px; height:20px; top:-22px; }
    }
  </style>
</head>
<body>
  <div class="scene" id="scene">
    <div class="header">
      <div class="title">üéÇ Blow Out the Candles to Unlock the Invite</div>
      <div class="hint">Tip: Click / swipe over candles ‚Äî or enable your mic and <strong>really blow</strong>!</div>
    </div>

    <div class="controls">
      <button id="micBtn" type="button">üéôÔ∏è Enable Microphone</button>
      <span class="badge" id="micStatus">Mic: off</span>
      <div class="meter" title="Mic level"><i id="meterFill"></i></div>
      <span class="meter-label" id="meterLabel">0%</span>
      <span class="badge" id="progress" aria-live="polite">0 / 25 out</span>
      <button id="relightBtn" type="button" title="Relight all candles">Relight</button>
    </div>

    <div class="stage" id="stage">
      <div class="cake-wrap">
        <div class="cake" id="cake">
          <div class="half left"></div>
          <div class="half right"></div>
          <div class="candles" id="candles"></div>
        </div>
      </div>
      <div class="table"></div>

      <div class="invite" id="invite" aria-hidden="true">
        <h2>You're Invited! ü•≥</h2>
        <div class="grid">
          <div class="row"><span class="pill">Who</span> <div><strong>Roxanne‚Äôs Birthday</strong></div></div>
          <div class="row"><span class="pill">When</span> <div><strong>Friday, 5th Sept 2025</strong> ‚Äî 8:30 PM</div></div>
          <div class="row"><span class="pill">Where</span> <div><a href="https://www.lesbouchonsmalaysia.com/puteri-harbour-johor-bahru" target="_blank" rel="noopener"><strong>Les Bouchons Puteri Harbour</strong></div></div>
          <div class="row"><span class="pill">Dress Code</span> <div>Party vibes ‚ú®</div></div>
          <div class="row"><span class="pill">Note</span> <div>Bring your best wish ‚Äî and your appetite! üç∞</div></div>
        </div>
        <div class="footer">
          <a class="rsvp" href="https://wa.me/" target="_blank" rel="noopener">WhatsApp RSVP</a>
          <div class="progress" id="doneMsg">All candles out ‚Äî cake unlocked!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- confetti layer (empty until trigger) -->
  <div class="confetti" id="confetti"></div>

  <div class="toast" id="toast"></div>

  <script>
    // ‚Äî‚Äî‚Äî CONFIG ‚Äî‚Äî‚Äî
    const TOTAL_CANDLES = 25;              // number of candles
    const MIC_THRESHOLD = 0.08;            // ~0..1 RMS energy needed to start blowing
    const MIC_HARD = 0.18;                 // strong blow threshold
    const MIC_SUSTAIN_MS = 120;            // sustain over threshold before counting as a gust
    const SWIPE_RADIUS = 34;               // px radius around pointer to extinguish

    const state = {
      candles: [],
      outCount: 0,
      blowingSince: 0,
      micEnabled: false,
      raf: null,
      unlocked: false,
      audio: { ctx:null, analyser:null, data:null, stream:null },
    };

    const els = {
      candles: document.getElementById('candles'),
      cake: document.getElementById('cake'),
      invite: document.getElementById('invite'),
      progress: document.getElementById('progress'),
      micBtn: document.getElementById('micBtn'),
      micStatus: document.getElementById('micStatus'),
      meterFill: document.getElementById('meterFill'),
      meterLabel: document.getElementById('meterLabel'),
      relightBtn: document.getElementById('relightBtn'),
      toast: document.getElementById('toast'),
      stage: document.getElementById('stage'),
      confetti: document.getElementById('confetti'),
    };

    // Build candles evenly across the cake top
    function buildCandles(){
      els.candles.innerHTML = '';
      state.candles = [];
      state.outCount = 0;
      state.unlocked = false;
      updateProgress();

      for(let i=0;i<TOTAL_CANDLES;i++){
        const c = document.createElement('div');
        c.className = 'candle';
        c.dataset.index = i;
        const pct = (i+1)/(TOTAL_CANDLES+1); // 0..1 avoiding edges
        const jitter = (Math.random()-.5) * (100/TOTAL_CANDLES) * .32; // small wobble
        c.style.left = `calc(${(pct*100).toFixed(2)}% + ${jitter.toFixed(2)}px)`;

        const wax = document.createElement('div'); wax.className = 'wax';
        const wick = document.createElement('div'); wick.className = 'wick';
        const flame = document.createElement('div'); flame.className = 'flame';
        const smoke = document.createElement('div'); smoke.className = 'smoke';

        c.appendChild(wax); c.appendChild(wick); c.appendChild(flame); c.appendChild(smoke);
        els.candles.appendChild(c);

        state.candles.push({ el:c, out:false, x:0, y:0 });
      }

      updateCandleCenters();
    }

    function updateCandleCenters(){
      state.candles.forEach(({el}, idx) => {
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width/2; const cy = r.top - 16; // flame above
        state.candles[idx].x = cx; state.candles[idx].y = cy;
      });
    }

    window.addEventListener('resize', () => { requestAnimationFrame(updateCandleCenters); });

    function showToast(msg){
      els.toast.textContent = msg; els.toast.classList.add('show');
      setTimeout(()=> els.toast.classList.remove('show'), 2200);
    }

    function updateProgress(){ els.progress.textContent = `${state.outCount} / ${TOTAL_CANDLES} out`; }

    function makePuffs(el, n=3){
      const smoke = el.querySelector('.smoke');
      for(let i=0;i<n;i++){
        const p = document.createElement('div'); p.className = 'puff';
        const dx = (Math.random()-.5)*24; const delay = Math.random()*0.25; const dur = 0.9 + Math.random()*0.7;
        p.style.setProperty('--dx', `${dx}px`);
        p.style.animationDelay = `${delay}s`; p.style.animationDuration = `${dur}s`;
        smoke.appendChild(p);
        setTimeout(()=> p.remove(), (delay+dur)*1000 + 20);
      }
    }

    function extinguish(idx){
      const c = state.candles[idx]; if(!c || c.out) return;
      c.out = true; c.el.classList.add('out');
      makePuffs(c.el, 3 + Math.floor(Math.random()*3));
      state.outCount++; updateProgress();
      if(state.outCount >= TOTAL_CANDLES) unlockInvite();
    }

    function relightAll(){
      state.candles.forEach(c=>{ c.out=false; c.el.classList.remove('out'); });
      state.outCount = 0; updateProgress();
      els.cake.classList.remove('open');
      els.invite.classList.remove('show'); els.invite.setAttribute('aria-hidden','true');
      els.confetti.innerHTML = '';
      state.unlocked = false;
    }

    function unlockInvite(){
      if(state.unlocked) return; // guard against double-calls
      state.unlocked = true;
      els.cake.classList.add('open');
      els.invite.classList.add('show'); els.invite.setAttribute('aria-hidden','false');
      showToast('‚ú® Make a wish! Invite unlocked.');
      launchConfettiBurst();
    }

    // Pointer interactions ‚Äî click / swipe to put out
    let pointerDown = false;
    ['pointerdown','pointerup','pointercancel','pointerleave'].forEach(ev=>{
      els.stage.addEventListener(ev, e=>{ pointerDown = (ev==='pointerdown'); });
    });
    els.stage.addEventListener('pointermove', onPoint);
    els.stage.addEventListener('pointerdown', onPoint);

    function onPoint(e){
      if(e.pointerType==='mouse' && !pointerDown) return; // drag for mouse; tap works on touch/pen
      const px = e.clientX, py = e.clientY;
      for(let i=0;i<state.candles.length;i++){
        const c = state.candles[i]; if(c.out) continue;
        const dx = c.x - px, dy = c.y - py; const d = Math.hypot(dx,dy);
        if(d < SWIPE_RADIUS){ extinguish(i); }
      }
    }

    // ‚Äî‚Äî‚Äî Microphone blowing detection ‚Äî‚Äî‚Äî
    async function enableMic(){
      if(state.micEnabled){ showToast('Mic already on. Blow to put out!'); return; }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }, video:false
        });
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const src = ctx.createMediaStreamSource(stream);
        const analyser = ctx.createAnalyser(); analyser.fftSize = 2048; analyser.smoothingTimeConstant = 0.2;
        src.connect(analyser);
        const data = new Float32Array(analyser.fftSize);
        state.audio = { ctx, analyser, data, stream };
        state.micEnabled = true; els.micStatus.textContent = 'Mic: on';
        loopMic();
        showToast('Mic on. Blow towards your phone!');
      }catch(err){
        console.error(err);
        showToast('Mic blocked. Use swipe/click instead.');
        els.micStatus.textContent = 'Mic: blocked';
      }
    }

    function levelToPct(lvl){ return Math.min(100, Math.max(0, Math.round(lvl*160))); }

    function loopMic(){
      const { analyser, data } = state.audio; if(!analyser) return;
      analyser.getFloatTimeDomainData(data);
      // compute RMS
      let sum = 0; for(let i=0;i<data.length;i++){ const v = data[i]; sum += v*v; }
      const rms = Math.sqrt(sum / data.length); // ~0..1

      els.meterFill.style.width = `${levelToPct(rms)}%`;
      els.meterLabel.textContent = `${levelToPct(rms)}%`;

      const now = performance.now();
      if(rms > MIC_THRESHOLD){
        if(state.blowingSince===0) state.blowingSince = now;
        if(now - state.blowingSince > MIC_SUSTAIN_MS){
          const strength = Math.min(1, (rms - MIC_THRESHOLD) / (MIC_HARD - MIC_THRESHOLD + 0.0001));
          const toOut = 1 + Math.floor(strength * 3); // 1..4 per gust
          blowOutRandom(toOut);
          state.blowingSince = now - MIC_SUSTAIN_MS/2; // allow continuous blowing to keep working
        }
      } else {
        state.blowingSince = 0;
      }

      state.raf = requestAnimationFrame(loopMic);
    }

    function blowOutRandom(n){
      const aliveIdx = state.candles.map((c,i)=> c.out? -1 : i).filter(i=> i!==-1);
      if(aliveIdx.length===0) return;
      for(let k=0;k<n;k++){
        if(aliveIdx.length===0) break;
        const pick = Math.floor(Math.random()*aliveIdx.length);
        const idx = aliveIdx.splice(pick,1)[0];
        extinguish(idx);
      }
    }

    // One-time confetti burst
    function launchConfettiBurst(){
      els.confetti.innerHTML = '';
      const colors = ['#ff595e','#ffca3a','#8ac926','#1982c4','#6a4c93','#ffd166'];
      const pieces = 180;
      for(let i=0;i<pieces;i++){
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random()*100 + 'vw';
        piece.style.top = (-10 - Math.random()*30) + 'px';
        piece.style.background = colors[Math.floor(Math.random()*colors.length)];
        const w = 6 + Math.random()*10, h = 8 + Math.random()*12;
        piece.style.width = w+'px'; piece.style.height = h+'px';
        const dur = 2.4 + Math.random()*2.6; piece.style.animationDuration = dur+'s';
        piece.style.animationDelay = (Math.random()*0.6)+'s';
        piece.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
        els.confetti.appendChild(piece);
        setTimeout(()=> piece.remove(), (dur+1.2)*1000);
      }
      // auto-clear container after a while
      setTimeout(()=>{ els.confetti.innerHTML=''; }, 7000);
    }

    // Controls
    els.micBtn.addEventListener('click', async ()=>{
      await enableMic();
      if(state.audio.ctx && state.audio.ctx.state==='suspended'){
        try{ await state.audio.ctx.resume(); }catch(e){}
      }
    });
    els.relightBtn.addEventListener('click', relightAll);

    // Keyboard helper for demo: press B to blow, R to relight
    window.addEventListener('keydown', e=>{
      if(e.key.toLowerCase()==='b') blowOutRandom(3);
      if(e.key.toLowerCase()==='r') relightAll();
    });

    // init
    buildCandles();
  </script>
</body>
</html>
